# Progress Log

## Learnings
(Patterns discovered during implementation)

---
## Iteration 1 - Artifact service root mapping and tree listing
- Implemented `ArtifactService` class with root aliases (`research`, `results`, `prds`, `memory`), strict root/path validation, recursive tree listing, and document reads in `services/artifact-service.js`.
- Added TDD coverage in `tests/services/artifact-service.test.js` for root listing, tree enumeration, PRD filtering, doc reads, traversal blocking, and unknown-root rejection.
- Learnings for future iterations: keep new backend services class-based with explicit error `code`/`status`; initialize PRD tasks as checklists to keep one-task iteration flow deterministic.
**Summary:** Task: [US-TASK1] | Files: [services/artifact-service.js, tests/services/artifact-service.test.js, PRD_ATHENA_WEB.md] | Tests: [PASS] | Review: [PASSED] | Next: [Task 2: Artifact API routes]
---
## Iteration 2 - Artifact API routes
- Implemented new artifact API endpoints in `routes/artifacts.js`: `GET /api/artifacts/roots`, `GET /api/artifacts/tree`, and `GET /api/artifacts/doc` with structured error mapping from `ArtifactService`.
- Extended `services/artifact-service.js` with `readDocWithMetadata(root, path)` so `/doc` returns markdown plus metadata (`mtime`, `size`) while keeping `readDoc` behavior unchanged.
- Replaced `tests/routes/artifacts.test.js` with TDD coverage for endpoint success paths and required error cases (invalid root 404, traversal 400, missing file 404).
- Learnings for future iterations: keep query-param validation at route boundary and keep service-layer errors canonical (`code` + `status`) so route handlers stay thin.
**Summary:** Task: [US-TASK2] | Files: [routes/artifacts.js, services/artifact-service.js, tests/routes/artifacts.test.js, PRD_ATHENA_WEB.md] | Tests: [PASS] | Review: [PASSED] | Next: [Task 3: Artifact search endpoint]
---
## Iteration 3 - Artifact search endpoint
- Implemented `/api/artifacts/search` in `routes/artifacts.js` using `spawn('rg', args)` with args-array invocation (no shell), scoped search roots, query/root/limit validation, and structured `{ root, path, line, snippet }` results.
- Added TDD coverage in `tests/routes/artifacts-search.test.js` for successful search matches, empty results, shell-injection-style input handling, and invalid root rejection.
- Learnings for future iterations: when wrapping CLI search, run one root scope at a time with a global limit to keep output mapping deterministic and preserve strict root allowlisting.
**Summary:** Task: [US-TASK3] | Files: [routes/artifacts.js, tests/routes/artifacts-search.test.js, PRD_ATHENA_WEB.md] | Tests: [PASS] | Review: [PASSED] | Next: [Task 4: Inbox service — file and text submission]
---
## Iteration 4 - Inbox service — file and text submission
- Replaced `services/inbox-service.js` with a class-based `InboxService` supporting configurable `inboxPath`, status subdirectories (`incoming/processing/done/failed`), `submitFile`, `submitText`, and `list(status)` with `.meta.json` sidecars and SHA-256 metadata.
- Implemented atomic writes using temp files + rename for both payload and sidecar, with cleanup to prevent partial files on failure; preserved compatibility exports (`saveText`, `saveFile`, `listInbox`, `validateUploadFile`, `MAX_UPLOAD_BYTES`) so existing inbox routes/tests remain stable.
- Added TDD coverage in `tests/services/inbox-service.test.js` for file submit, text submit, status listing, size-limit enforcement, and no leftover temp files.
- Learnings for future iterations: when evolving a shared service contract, keep a compatibility layer during phase transitions so route-level behavior remains stable while new class APIs are introduced.
**Summary:** Task: [US-TASK4] | Files: [services/inbox-service.js, tests/services/inbox-service.test.js, PRD_ATHENA_WEB.md, progress_athena_web.txt] | Tests: [PASS] | Review: [PASSED] | Next: [Task 5: Inbox API routes]
---

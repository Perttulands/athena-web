# Progress Log

## Learnings
(Patterns discovered during implementation)

---
## Iteration 1 - Artifact service root mapping and tree listing
- Implemented `ArtifactService` class with root aliases (`research`, `results`, `prds`, `memory`), strict root/path validation, recursive tree listing, and document reads in `services/artifact-service.js`.
- Added TDD coverage in `tests/services/artifact-service.test.js` for root listing, tree enumeration, PRD filtering, doc reads, traversal blocking, and unknown-root rejection.
- Learnings for future iterations: keep new backend services class-based with explicit error `code`/`status`; initialize PRD tasks as checklists to keep one-task iteration flow deterministic.
**Summary:** Task: [US-TASK1] | Files: [services/artifact-service.js, tests/services/artifact-service.test.js, PRD_ATHENA_WEB.md] | Tests: [PASS] | Review: [PASSED] | Next: [Task 2: Artifact API routes]
---
## Iteration 2 - Artifact API routes
- Implemented new artifact API endpoints in `routes/artifacts.js`: `GET /api/artifacts/roots`, `GET /api/artifacts/tree`, and `GET /api/artifacts/doc` with structured error mapping from `ArtifactService`.
- Extended `services/artifact-service.js` with `readDocWithMetadata(root, path)` so `/doc` returns markdown plus metadata (`mtime`, `size`) while keeping `readDoc` behavior unchanged.
- Replaced `tests/routes/artifacts.test.js` with TDD coverage for endpoint success paths and required error cases (invalid root 404, traversal 400, missing file 404).
- Learnings for future iterations: keep query-param validation at route boundary and keep service-layer errors canonical (`code` + `status`) so route handlers stay thin.
**Summary:** Task: [US-TASK2] | Files: [routes/artifacts.js, services/artifact-service.js, tests/routes/artifacts.test.js, PRD_ATHENA_WEB.md] | Tests: [PASS] | Review: [PASSED] | Next: [Task 3: Artifact search endpoint]
---
## Iteration 3 - Artifact search endpoint
- Implemented `/api/artifacts/search` in `routes/artifacts.js` using `spawn('rg', args)` with args-array invocation (no shell), scoped search roots, query/root/limit validation, and structured `{ root, path, line, snippet }` results.
- Added TDD coverage in `tests/routes/artifacts-search.test.js` for successful search matches, empty results, shell-injection-style input handling, and invalid root rejection.
- Learnings for future iterations: when wrapping CLI search, run one root scope at a time with a global limit to keep output mapping deterministic and preserve strict root allowlisting.
**Summary:** Task: [US-TASK3] | Files: [routes/artifacts.js, tests/routes/artifacts-search.test.js, PRD_ATHENA_WEB.md] | Tests: [PASS] | Review: [PASSED] | Next: [Task 4: Inbox service — file and text submission]
---
## Iteration 4 - Inbox service — file and text submission
- Replaced `services/inbox-service.js` with a class-based `InboxService` supporting configurable `inboxPath`, status subdirectories (`incoming/processing/done/failed`), `submitFile`, `submitText`, and `list(status)` with `.meta.json` sidecars and SHA-256 metadata.
- Implemented atomic writes using temp files + rename for both payload and sidecar, with cleanup to prevent partial files on failure; preserved compatibility exports (`saveText`, `saveFile`, `listInbox`, `validateUploadFile`, `MAX_UPLOAD_BYTES`) so existing inbox routes/tests remain stable.
- Added TDD coverage in `tests/services/inbox-service.test.js` for file submit, text submit, status listing, size-limit enforcement, and no leftover temp files.
- Learnings for future iterations: when evolving a shared service contract, keep a compatibility layer during phase transitions so route-level behavior remains stable while new class APIs are introduced.
**Summary:** Task: [US-TASK4] | Files: [services/inbox-service.js, tests/services/inbox-service.test.js, PRD_ATHENA_WEB.md, progress_athena_web.txt] | Tests: [PASS] | Review: [PASSED] | Next: [Task 5: Inbox API routes]
---
## Iteration 5 - Inbox API routes
- Implemented inbox API updates in `routes/inbox.js`: added `GET /api/inbox/list?status=...`, switched `POST /api/inbox/text` to `{title,text,format}` (with `content` fallback), wired `POST /api/inbox/upload` to `InboxService.submitFile`, and added a shared in-memory rate limiter (10 submissions/minute).
- Replaced route tests in `tests/routes/inbox.test.js` with TDD coverage for upload flow, text submit flow, status list endpoint, rate-limit `429`, and oversized upload rejection `413`.
- Learnings for future iterations: when adding cross-request controls like rate limits, keep route tests ordered to avoid shared-state interference and assert endpoint contracts directly (`status`, payload shape) instead of only existence checks.
**Summary:** Task: [US-TASK5] | Files: [routes/inbox.js, tests/routes/inbox.test.js, PRD_ATHENA_WEB.md, progress_athena_web.txt] | Tests: [PASS] | Review: [PASSED] | Next: [Task 6: Portal page shell — tab navigation]
---
## Iteration 6 - Portal page shell - tab navigation
- Implemented `public/js/pages/portal.js` as a tabbed shell page with internal tabs (Artifacts, Inbox, Workspace) and delegated mount/unmount wiring to existing page modules so Workspace uses current Scrolls content.
- Updated router and nav wiring in `public/js/app.js` and `public/index.html` to add `#/portal`, keep `#/scrolls` as alias, and canonicalize active nav to the Portal tab; extended `public/css/pages.css` with mobile-first full-width tab styles.
- Added TDD coverage in `tests/frontend/pages/portal.test.js` and updated `tests/frontend/router.test.js` (plus nav fixture in `tests/frontend/accessibility.test.js`) for route rendering, tab switching, and scrolls alias behavior.
- Learnings for future iterations: when introducing route aliases, canonicalize both loader resolution and active-nav state in one place to avoid drift between URL compatibility and visible navigation.
**Summary:** Task: [US-TASK6] | Files: [public/js/pages/portal.js, public/js/app.js, public/index.html, public/css/pages.css, tests/frontend/pages/portal.test.js, tests/frontend/router.test.js, tests/frontend/accessibility.test.js, PRD_ATHENA_WEB.md] | Tests: [PASS] | Review: [PASSED] | Next: [Task 7: Artifact browser UI]
---
